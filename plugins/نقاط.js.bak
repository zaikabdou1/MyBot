const fs = require('fs');
const path = require('path');

const pointsFile = path.join(__dirname, '../data/ranks.json');   // Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
const xpFile = path.join(__dirname, '../data/xp.json');          // Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠØ© Ù„ÙƒÙ„ Ø§Ù„Ø¹Ø¶Ùˆ
const levelsFile = path.join(__dirname, '../data/levels.json');  // Ø§Ù„ÙÙ„Ø§Øª ÙˆØ§Ù„Ø´Ø§Ø±Ø§Øª

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡Ù‡Ø§ ÙØ§Ø±ØºØ©
let points = fs.existsSync(pointsFile) ? JSON.parse(fs.readFileSync(pointsFile)) : {};
let xp = fs.existsSync(xpFile) ? JSON.parse(fs.readFileSync(xpFile)) : {};
let levels = fs.existsSync(levelsFile) ? JSON.parse(fs.readFileSync(levelsFile)) : {};

const ARISE_LEVEL = 'ğ€ğ‘ğˆğ’ğ„ ğ‹ğ„ğ•ğ„ğ‹';

// Ø§Ù„Ø±ØªØ¨ Ø­Ø³Ø¨ Ø°ÙˆÙ‚Ùƒ ÙˆØ§Ù„Ø²Ø®Ø±ÙØ©
const rankTitles = [
  'ğŸ›¡ï¸ Ø¬Ù†Ø¯ÙŠ âš”ï¸',
  'ğŸ—¡ï¸ Ù…Ø­Ø§Ø±Ø¨ ğŸ¹',
  'ğŸ–ï¸ Ù…Ù„Ø§Ø²Ù… ğŸ°',
  'ğŸ ÙØ§Ø±Ø³ âš¡',
  'ğŸ”¥ Ù…Ø§Ø±Ø´Ø§Ù„ ğŸ’¥',
  'ğŸ’ Ø¬Ù†Ø±Ø§Ù„ âšœï¸',
  'ğŸŒŸ Ù‚Ø§Ø¦Ø¯ Ø£Ø¹Ù„Ù‰ âœ¨',
  'ğŸŒ‘ Ù…Ù„Ùƒ Ø§Ù„Ø¸Ù„Ø§Ù„ ğŸ‘‘'
];

// Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„ÙƒÙ„ Ø±ØªØ¨Ø©
const rankThresholds = [
  0,
  100_000,
  300_000,
  700_000,
  1_500_000,
  3_000_000,
  6_000_000,
  10_000_000
];

// ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù„ØµÙŠØºØ© K/M
function formatK(num) {
  if (num >= 1_000_000) return (num / 1_000_000).toFixed(1).replace(/\.0$/, '') + 'm';
  if (num >= 1000) return (num / 1000).toFixed(1).replace(/\.0$/, '') + 'k';
  return num.toString();
}

// Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
function saveData() {
  fs.writeFileSync(pointsFile, JSON.stringify(points, null, 2));
  fs.writeFileSync(xpFile, JSON.stringify(xp, null, 2));
  fs.writeFileSync(levelsFile, JSON.stringify(levels, null, 2));
}

// ØªØ­Ø¯ÙŠØ« Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ XP Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ
function updateLevel(sender) {
  if (!levels[sender]) levels[sender] = { level: 0, title: rankTitles[0], purchases: 0 };
  if (!xp[sender]) xp[sender] = 0;

  let newLevel = 0;
  for (let i = 0; i < rankThresholds.length; i++) {
    if (xp[sender] >= rankThresholds[i]) newLevel = i;
  }
  levels[sender].level = newLevel;
  levels[sender].title = rankTitles[newLevel];

  saveData();
}

// Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø· â†’ ÙŠØ²ÙŠØ¯ Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ + XP ØªØ±Ø§ÙƒÙ…ÙŠ
function addPoints(sender, amount) {
  if (!points[sender]) points[sender] = 0;
  if (!xp[sender]) xp[sender] = 0;
  if (!levels[sender]) levels[sender] = { level: 0, title: rankTitles[0], purchases: 0 };

  points[sender] += amount;  // Ø²ÙŠØ§Ø¯Ø© Ø§Ù„Ø±ØµÙŠØ¯
  xp[sender] += amount;      // Ø²ÙŠØ§Ø¯Ø© XP Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ
  updateLevel(sender);
}

// Ø®ØµÙ… Ù†Ù‚Ø§Ø· â†’ ÙŠÙ†Ù‚Øµ Ø§Ù„Ø±ØµÙŠØ¯ ÙÙ‚Ø·ØŒ XP Ø§Ù„ØªØ±Ø§ÙƒÙ…ÙŠ Ù„Ø§ ÙŠØªØ£Ø«Ø±
function subtractPoints(sender, amount) {
  if (!points[sender]) points[sender] = 0;

  points[sender] -= amount;
  if (points[sender] < 0) points[sender] = 0;

  saveData();
}

// ØªØ³Ø¬ÙŠÙ„ Ø´Ø±Ø§Ø¡ â†’ ÙŠÙ†Ù‚Øµ Ø§Ù„Ø±ØµÙŠØ¯ ÙˆÙŠØ²ÙŠØ¯ Ø§Ù„Ø´Ø§Ø±Ø§Øª
function purchase(sender, cost) {
  if (!points[sender]) points[sender] = 0;
  if (!levels[sender]) levels[sender] = { level: 0, title: rankTitles[0], purchases: 0 };

  if (points[sender] < cost) return false;

  points[sender] -= cost;
  levels[sender].purchases += 1;
  saveData();
  return true;
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø¶Ùˆ
function getStatus(sender) {
  if (!points[sender]) points[sender] = 0;
  if (!xp[sender]) xp[sender] = 0;
  if (!levels[sender]) levels[sender] = { level: 0, title: rankTitles[0], purchases: 0 };

  return {
    points: points[sender],
    xp: xp[sender],
    title: levels[sender].title,
    level: levels[sender].level,
    purchases: levels[sender].purchases
  };
}

// Ø§Ù„Ø£Ù…Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ù„Ù„Ø¨ÙˆØª
module.exports = {
  command: 'Ø±ØµÙŠØ¯ÙŠ',
  category: 'info',
  description: 'Ø§Ø¹Ø±Ø¶ Ø±ØµÙŠØ¯ÙƒØŒ XPØŒ ÙˆØ±ØªØ¨ØªÙƒ ÙÙŠ ARISE LEVEL ğŸ¯',

  async execute(sock, msg) {
    const sender = msg.key.participant || msg.key.remoteJid;

    if (!points[sender]) points[sender] = 0;
    if (!xp[sender]) xp[sender] = 0;
    if (!levels[sender]) levels[sender] = { level: 0, title: rankTitles[0], purchases: 0 };

    updateLevel(sender);

    const { title, level } = levels[sender];
    const formattedPoints = formatK(points[sender]);

    await sock.sendMessage(msg.key.remoteJid, {
      text: `Ø±ØµÙŠØ¯Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ ğŸ’°: *${formattedPoints}* Ù†Ù‚Ø·Ø©\n` +
            `${ARISE_LEVEL}: *${title}*\n` +
            `> *Level ${level}*`
    }, { quoted: msg });
  }
};

// ØªØµØ¯ÙŠØ± Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡Ø§ ÙÙŠ Ø£ÙŠ Ø£ÙˆØ§Ù…Ø± Ø¥Ø¶Ø§ÙØ©/Ø®ØµÙ…/Ø´Ø±Ø§Ø¡
module.exports.addPoints = addPoints;
module.exports.subtractPoints = subtractPoints;
module.exports.purchase = purchase;
module.exports.getStatus = getStatus;